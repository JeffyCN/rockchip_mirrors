From d2d9c62ed1fbd4dc7b6e60d1d6512343006907d2 Mon Sep 17 00:00:00 2001
From: Jeffy Chen <jeffy.chen@rock-chips.com>
Date: Mon, 3 Dec 2018 10:40:16 +0800
Subject: [PATCH 33/98] compositor: Support freezing display

Freeze display when the specified file(from env "WESTON_FREEZE_DISPLAY")
exists.

For example:
export WESTON_FREEZE_DISPLAY=/tmp/.freeze
touch $WESTON_FREEZE_DISPLAY
weston --tty=2 -Bdrm-backend.so&

Signed-off-by: Jeffy Chen <jeffy.chen@rock-chips.com>
---
 libweston/compositor.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/libweston/compositor.c b/libweston/compositor.c
index e69edaf9..7383154e 100644
--- a/libweston/compositor.c
+++ b/libweston/compositor.c
@@ -3623,6 +3623,12 @@ output_repaint_timer_handler(void *data)
 	struct timespec now;
 	int ret = 0;
 
+	if (!access(getenv("WESTON_FREEZE_DISPLAY") ? : "", F_OK)) {
+		usleep(DEFAULT_REPAINT_WINDOW * 1000);
+		weston_compositor_build_view_list(compositor);
+		goto out;
+	}
+
 	weston_compositor_read_presentation_clock(compositor, &now);
 	compositor->last_repaint_start = now;
 
@@ -3663,6 +3669,7 @@ output_repaint_timer_handler(void *data)
 	wl_list_for_each(output, &compositor->output_list, link)
 		output->repainted = false;
 
+out:
 	output_repaint_timer_arm(compositor);
 
 	return 0;
-- 
2.20.1

