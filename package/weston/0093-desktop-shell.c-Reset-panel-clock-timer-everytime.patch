From d7de0d9339ab0d83692eabff89109ea4c1dac2d2 Mon Sep 17 00:00:00 2001
From: Jeffy Chen <jeffy.chen@rock-chips.com>
Date: Thu, 19 Oct 2023 17:33:19 +0800
Subject: [PATCH 93/98] desktop-shell.c: Reset panel clock timer everytime

In case of the system time been changed.

Signed-off-by: Jeffy Chen <jeffy.chen@rock-chips.com>
---
 clients/desktop-shell.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/clients/desktop-shell.c b/clients/desktop-shell.c
index bf75927..67289e2 100644
--- a/clients/desktop-shell.c
+++ b/clients/desktop-shell.c
@@ -531,12 +531,16 @@ panel_launcher_tablet_tool_button_handler(struct widget *widget,
 		launcher_activate(launcher->argp, launcher->envp);
 }
 
+static int clock_timer_reset(struct panel_clock *clock);
+
 static void
 clock_func(struct toytimer *tt)
 {
 	struct panel_clock *clock = container_of(tt, struct panel_clock, timer);
 
 	widget_schedule_redraw(clock->widget);
+
+	clock_timer_reset(clock);
 }
 
 static void
@@ -589,7 +593,7 @@ clock_timer_reset(struct panel_clock *clock)
 	clock_gettime(CLOCK_REALTIME, &ts);
 	tm = localtime(&ts.tv_sec);
 
-	its.it_interval.tv_sec = clock->refresh_timer;
+	its.it_interval.tv_sec = 0;
 	its.it_interval.tv_nsec = 0;
 	its.it_value.tv_sec = clock->refresh_timer - tm->tm_sec % clock->refresh_timer;
 	its.it_value.tv_nsec = 10000000; /* 10 ms late to ensure the clock digit has actually changed */
-- 
2.20.1

