From a4707f060dfc6c52ba3a7ff2d8a1bc3905e5a9e0 Mon Sep 17 00:00:00 2001
From: Jeffy Chen <jeffy.chen@rock-chips.com>
Date: Tue, 16 Jan 2024 16:44:14 +0800
Subject: [PATCH 96/98] compositor: Skip painting output before the background
 is ready

Signed-off-by: Jeffy Chen <jeffy.chen@rock-chips.com>
---
 libweston/compositor.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/libweston/compositor.c b/libweston/compositor.c
index d7dc03b4..f4625c08 100644
--- a/libweston/compositor.c
+++ b/libweston/compositor.c
@@ -3510,6 +3510,7 @@ weston_output_repaint(struct weston_output *output)
 	int r;
 	uint32_t frame_time_msec;
 	enum weston_hdcp_protection highest_requested = WESTON_HDCP_DISABLE;
+	bool has_background = false;
 
 	if (output->destroying)
 		return 0;
@@ -3527,10 +3528,21 @@ weston_output_repaint(struct weston_output *output)
 
 	wl_list_for_each(pnode, &output->paint_node_z_order_list,
 			 z_order_link) {
+	  struct weston_layer *layer = pnode->view->layer_link.layer;
+
+		if (layer && layer->position == WESTON_LAYER_POSITION_BACKGROUND)
+			has_background = true;
+
 		assert(pnode->view->output_mask & (1u << pnode->output->id));
 		assert(pnode->output == output);
 	}
 
+	if (weston_output_valid(output) && !has_background) {
+		timespec_add_nsec(&output->next_repaint, &output->next_repaint,
+				  millihz_to_nsec(output->current_mode->refresh));
+		return 1;
+	}
+
 	/* Find the highest protection desired for an output */
 	wl_list_for_each(pnode, &output->paint_node_z_order_list,
 			 z_order_link) {
-- 
2.20.1

