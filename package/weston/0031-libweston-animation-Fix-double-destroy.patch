From b811be40f5b5728354bc7744ce0088133140ca8e Mon Sep 17 00:00:00 2001
From: Jeffy Chen <jeffy.chen@rock-chips.com>
Date: Fri, 9 Oct 2020 18:00:11 +0800
Subject: [PATCH 31/98] libweston: animation: Fix double-destroy

Signed-off-by: Jeffy Chen <jeffy.chen@rock-chips.com>
---
 libweston/animation.c       | 9 ++++++++-
 libweston/backend-drm/drm.c | 1 -
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/libweston/animation.c b/libweston/animation.c
index 22a2e1c..f4dff27 100644
--- a/libweston/animation.c
+++ b/libweston/animation.c
@@ -136,6 +136,7 @@ struct weston_view_animation {
 	weston_view_animation_frame_func_t frame;
 	weston_view_animation_frame_func_t reset;
 	weston_view_animation_done_func_t done;
+	struct wl_event_source *idle_destroy_source;
 	void *data;
 	void *private;
 };
@@ -143,6 +144,9 @@ struct weston_view_animation {
 WL_EXPORT void
 weston_view_animation_destroy(struct weston_view_animation *animation)
 {
+	if (animation->idle_destroy_source)
+		wl_event_source_remove(animation->idle_destroy_source);
+
 	wl_list_remove(&animation->animation.link);
 	wl_list_remove(&animation->listener.link);
 	weston_view_remove_transform(animation->view, &animation->transform);
@@ -247,10 +251,13 @@ weston_view_animation_create(struct weston_view *view,
 	if (view->output) {
 		wl_list_insert(&view->output->animation_list,
 			       &animation->animation.link);
+		animation->idle_destroy_source = NULL;
 	} else {
 		wl_list_init(&animation->animation.link);
 		loop = wl_display_get_event_loop(ec->wl_display);
-		wl_event_loop_add_idle(loop, idle_animation_destroy, animation);
+		animation->idle_destroy_source =
+			wl_event_loop_add_idle(loop, idle_animation_destroy,
+					       animation);
 	}
 
 	return animation;
diff --git a/libweston/backend-drm/drm.c b/libweston/backend-drm/drm.c
index 06d603c..214335c 100644
--- a/libweston/backend-drm/drm.c
+++ b/libweston/backend-drm/drm.c
@@ -5255,7 +5255,6 @@ err_udev_monitor:
 	udev_monitor_unref(b->udev_monitor);
 err_drm_source:
 	wl_event_source_remove(b->drm_source);
-err_udev_input:
 	udev_input_destroy(&b->input);
 err_sprite:
 	destroy_sprites(b->drm);
-- 
2.20.1

