From 1a410c0d89bf2955886bd4a121a7f83f6a9a8e5a Mon Sep 17 00:00:00 2001
From: Jeffy Chen <jeffy.chen@rock-chips.com>
Date: Tue, 16 Jan 2024 16:44:14 +0800
Subject: [PATCH 97/97] compositor: Skip painting output before the background
 is ready

Signed-off-by: Jeffy Chen <jeffy.chen@rock-chips.com>
---
 libweston/compositor.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/libweston/compositor.c b/libweston/compositor.c
index 5539d6935d..8f2cb9f920 100644
--- a/libweston/compositor.c
+++ b/libweston/compositor.c
@@ -3484,6 +3484,7 @@ weston_output_repaint(struct weston_output *output)
 	int r;
 	uint32_t frame_time_msec;
 	enum weston_hdcp_protection highest_requested = WESTON_HDCP_DISABLE;
+	bool has_background = false;
 
 	if (output->destroying)
 		return 0;
@@ -3501,10 +3502,18 @@ weston_output_repaint(struct weston_output *output)
 
 	wl_list_for_each(pnode, &output->paint_node_z_order_list,
 			 z_order_link) {
+	  struct weston_layer *layer = pnode->view->layer_link.layer;
+
+		if (layer && layer->position == WESTON_LAYER_POSITION_BACKGROUND)
+			has_background = true;
+
 		assert(pnode->view->output_mask & (1u << pnode->output->id));
 		assert(pnode->output == output);
 	}
 
+	if (!output->unavailable && !has_background)
+		return 1;
+
 	/* Find the highest protection desired for an output */
 	wl_list_for_each(pnode, &output->paint_node_z_order_list,
 			 z_order_link) {
-- 
2.20.1

