From 6ec2b82adf69cff8d3ea6c9b799eba1ec5315ce9 Mon Sep 17 00:00:00 2001
From: Jeffy Chen <jeffy.chen@rock-chips.com>
Date: Thu, 15 Sep 2022 18:01:12 +0800
Subject: [PATCH 38/39] kmssink: Support scaling in modesetting

Signed-off-by: Jeffy Chen <jeffy.chen@rock-chips.com>
---
 sys/kms/gstkmssink.c | 31 ++++++++++++++++++++++---------
 1 file changed, 22 insertions(+), 9 deletions(-)

diff --git a/sys/kms/gstkmssink.c b/sys/kms/gstkmssink.c
index 78f58e3..f06eb6b 100644
--- a/sys/kms/gstkmssink.c
+++ b/sys/kms/gstkmssink.c
@@ -525,12 +525,6 @@ configure_mode_setting (GstKMSSink * self, GstVideoInfo * vinfo)
 
   GST_INFO_OBJECT (self, "configuring mode setting");
 
-  ensure_kms_allocator (self);
-  kmsmem = (GstKMSMemory *) gst_kms_allocator_bo_alloc (self->allocator, vinfo);
-  if (!kmsmem)
-    goto bo_failed;
-  fb_id = kmsmem->fb_id;
-
   conn = drmModeGetConnector (self->fd, self->conn_id);
   if (!conn)
     goto connector_failed;
@@ -542,9 +536,25 @@ configure_mode_setting (GstKMSSink * self, GstVideoInfo * vinfo)
       break;
     }
   }
+
+  /* Fallback to the last mode (using scale) */
+  if (!mode && self->can_scale && conn->count_modes) {
+    mode = &conn->modes[conn->count_modes - 1];
+
+    /* Hack this temp video info */
+    gst_video_info_set_format (vinfo, GST_VIDEO_INFO_FORMAT (vinfo),
+        mode->hdisplay, mode->vdisplay);
+  }
+
   if (!mode)
     goto mode_failed;
 
+  ensure_kms_allocator (self);
+  kmsmem = (GstKMSMemory *) gst_kms_allocator_bo_alloc (self->allocator, vinfo);
+  if (!kmsmem)
+    goto bo_failed;
+  fb_id = kmsmem->fb_id;
+
   err = drmModeSetCrtc (self->fd, self->crtc_id, fb_id, 0, 0,
       (uint32_t *) & self->conn_id, 1, mode);
   if (err)
@@ -720,7 +730,7 @@ ensure_allowed_caps (GstKMSSink * self, drmModeConnector * conn,
 
       format = gst_video_format_to_string (fmt);
 
-      if (mode) {
+      if (mode && !self->can_scale) {
         caps = gst_caps_new_simple ("video/x-raw",
             "format", G_TYPE_STRING, format,
             "width", G_TYPE_INT, mode->hdisplay,
@@ -1586,7 +1596,7 @@ gst_kms_sink_sync (GstKMSSink * self)
   } else if (self->sync_mode == GST_KMS_SYNC_VBLANK) {
     pageflip = FALSE;
   } else if (self->sync_mode == GST_KMS_SYNC_AUTO) {
-    pageflip = self->modesetting_enabled;
+    pageflip = self->modesetting_enabled && self->buffer_id;
   } else {
     return TRUE;
   }
@@ -1913,7 +1923,10 @@ gst_kms_sink_show_frame (GstVideoSink * vsink, GstBuffer * buf)
 
   GST_OBJECT_LOCK (self);
   if (self->modesetting_enabled) {
-    self->buffer_id = fb_id;
+    if (video_width == self->hdisplay && video_height == self->vdisplay)
+      self->buffer_id = fb_id;
+    else
+      self->buffer_id = 0;
 
     if (!self->render_rect.w || !self->render_rect.h)
       goto sync_frame;
-- 
2.20.1

